<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Snake Game </title>
    <style>
        :root {
            --bg-dark: #020617;
            --card-bg: #020617;
            --accent: #22c55e;
            --accent-soft: #4ade80;
            --danger: #f97373;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at top, #0b1120 0, #000 45%, #020617 100%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: "";
            position: fixed;
            inset: -30%;
            background:
                radial-gradient(circle at 10% 10%, rgba(56,189,248,0.08) 0, transparent 55%),
                radial-gradient(circle at 90% 0%, rgba(16,185,129,0.12) 0, transparent 60%),
                radial-gradient(circle at 50% 100%, rgba(139,92,246,0.09) 0, transparent 60%);
            opacity: 1;
            pointer-events: none;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        /* NEON THEME (Varsayƒ±lan - Mevcut Tema) */
        /* Mevcut stil zaten neon, deƒüi≈üiklik yok - body.theme-neon i√ßin √∂zel CSS gerekmez */

        /* RETRO THEME */
        body.theme-retro {
            background: #1a1a2e;
            color: #eaeaea;
        }

        body.theme-retro::before {
            opacity: 0;
        }

        body.theme-retro #game-wrapper {
            background: #16213e;
            border-radius: 0;
            box-shadow: 
                0 0 0 2px #0f3460,
                0 0 0 4px #16213e,
                inset 0 0 20px rgba(0,0,0,0.5);
        }

        body.theme-retro #game-card {
            background: #0f3460;
            border-radius: 0;
            box-shadow: 
                inset 0 0 0 1px #533483,
                0 0 0 2px #0f3460;
        }

        body.theme-retro canvas {
            background: #0f1419;
            border-radius: 0;
            border: 2px solid #533483;
            box-shadow: 
                0 0 0 1px #e94560,
                inset 0 0 10px rgba(233,69,96,0.2);
        }

        body.theme-retro .pill {
            background: rgba(83,52,131,0.3);
            border-color: #533483;
            border-radius: 0;
        }

        body.theme-retro .score-pill {
            background: rgba(233,69,96,0.2);
            border-color: #e94560;
        }

        body.theme-retro .level-pill {
            background: rgba(83,52,131,0.3);
            border-color: #533483;
        }

        body.theme-retro .high-pill {
            background: rgba(255,193,7,0.2);
            border-color: #ffc107;
        }

        body.theme-retro .speed-pill {
            background: rgba(233,69,96,0.2);
            border-color: #e94560;
        }

        body.theme-retro .auth-card,
        body.theme-retro .settings-card {
            background: #16213e;
            border-radius: 0;
            box-shadow: 
                0 0 0 2px #0f3460,
                0 0 0 4px #533483,
                inset 0 0 20px rgba(0,0,0,0.5);
        }

        body.theme-retro .form-input,
        body.theme-retro .control-option {
            background: #0f3460;
            border-color: #533483;
            border-radius: 0;
        }

        body.theme-retro .control-option:hover {
            background: #16213e;
            border-color: #e94560;
        }

        body.theme-retro .control-option.selected {
            background: rgba(233,69,96,0.2);
            border-color: #e94560;
        }

        body.theme-retro .auth-button,
        body.theme-retro .settings-button {
            background: linear-gradient(135deg, #e94560, #c73650);
            border-radius: 0;
            box-shadow: 0 2px 0 #8b2638;
        }

        body.theme-retro .auth-button:hover,
        body.theme-retro .settings-button:hover {
            box-shadow: 0 3px 0 #8b2638;
            transform: translateY(-1px);
        }

        body.theme-retro .logo-icon {
            filter: drop-shadow(0 0 2px rgba(233,69,96,0.8));
        }

        /* MINIMAL THEME */
        body.theme-minimal {
            background: #ffffff;
            color: #1f2937;
        }

        body.theme-minimal::before {
            opacity: 0;
        }

        body.theme-minimal #game-wrapper {
            background: #f9fafb;
            border-radius: 8px;
            padding: 18px 18px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        body.theme-minimal #game-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 14px 16px 12px;
            box-shadow: none;
            border: 1px solid #e5e7eb;
        }

        body.theme-minimal canvas {
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: none;
        }

        body.theme-minimal .pill {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #1f2937;
        }

        body.theme-minimal .score-pill {
            background: #ecfdf5;
            border-color: #10b981;
            color: #059669;
        }

        body.theme-minimal .level-pill {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
        }

        body.theme-minimal .high-pill {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        body.theme-minimal .speed-pill {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        body.theme-minimal .auth-card,
        body.theme-minimal .settings-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        body.theme-minimal .form-input,
        body.theme-minimal .control-option {
            background: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }

        body.theme-minimal .form-label,
        body.theme-minimal .settings-section-title {
            color: #6b7280;
        }

        body.theme-minimal .control-option:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        body.theme-minimal .control-option.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        body.theme-minimal .auth-button,
        body.theme-minimal .settings-button {
            background: #3b82f6;
            color: white;
            border-radius: 6px;
            box-shadow: none;
        }

        body.theme-minimal .auth-button:hover,
        body.theme-minimal .settings-button:hover {
            background: #2563eb;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        body.theme-minimal .auth-button.secondary,
        body.theme-minimal .settings-button.secondary {
            background: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }

        body.theme-minimal .auth-button.secondary:hover,
        body.theme-minimal .settings-button.secondary:hover {
            background: #f9fafb;
        }

        body.theme-minimal .subtitle,
        body.theme-minimal .text-muted {
            color: #6b7280;
        }

        body.theme-minimal h1 {
            color: #1f2937;
        }

        body.theme-minimal .auth-title {
            color: #3b82f6;
        }

        body.theme-minimal .menu-welcome {
            color: #1f2937;
        }

        body.theme-minimal .menu-username {
            color: #3b82f6;
        }

        body.theme-minimal .control-option-label {
            color: #1f2937;
        }

        body.theme-minimal .control-option-label div {
            color: #1f2937;
        }

        body.theme-minimal .settings-title {
            color: #3b82f6;
        }

        body.theme-minimal #overlay-inner {
            background: #ffffff;
            color: #1f2937;
        }

        body.theme-minimal #overlay-title {
            color: #dc2626;
        }

        body.theme-minimal #overlay-score {
            color: #1f2937;
        }

        body.theme-minimal #overlay-high {
            color: #6b7280;
        }

        body.theme-minimal #player-name {
            background: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }

        body.theme-minimal #player-name::placeholder {
            color: #9ca3af;
        }

        body.theme-minimal #info {
            color: #6b7280;
        }

        body.theme-minimal .status span {
            color: #3b82f6;
        }

        body.theme-minimal #leaderboard-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }

        body.theme-minimal #leaderboard-title {
            color: #6b7280;
        }

        body.theme-minimal #leaderboard-table thead th {
            color: #6b7280;
        }

        body.theme-minimal #leaderboard-table tbody tr {
            background: #f9fafb;
        }

        body.theme-minimal #leaderboard-table tbody tr:nth-child(even) {
            background: #ffffff;
        }

        body.theme-minimal .lb-name {
            color: #1f2937;
        }

        body.theme-minimal .lb-score {
            color: #3b82f6;
        }

        body.theme-minimal .lb-empty {
            color: #6b7280;
        }

        body.theme-minimal .error-message {
            color: #dc2626;
        }

        body.theme-minimal .success-message {
            color: #059669;
        }

        body.theme-minimal #save-status {
            color: #6b7280;
        }

        body.theme-minimal .logo-icon {
            filter: none;
        }

        h1 {
            margin: 26px 0 6px;
            font-size: 32px;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
        }

        .logo-icon {
            font-size: 26px;
            filter: drop-shadow(0 0 4px rgba(34,197,94,0.9));
        }

        .subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }

        #layout {
            margin-top: 26px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        #game-wrapper {
            background: radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
            border-radius: 22px;
            padding: 18px 18px 16px;
            box-shadow:
                0 25px 70px rgba(0,0,0,0.85),
                0 0 0 1px rgba(148,163,184,0.15);
        }

        #game-card {
            background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
            border-radius: 18px;
            padding: 14px 16px 12px;
            box-shadow:
                inset 0 0 0 1px rgba(148,163,184,0.17),
                0 18px 40px rgba(0,0,0,0.9);
        }

        canvas {
            display: block;
            background: #020617;
            border-radius: 14px;
            border: 2px solid rgba(15,23,42,0.8);
            box-shadow:
                0 0 0 1px #22c55e33,
                0 0 30px rgba(34,197,94,0.35);
        }

        #hud {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            gap: 10px;
        }

        .hud-left, .hud-right, .hud-center {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hud-center {
            flex: 1;
            justify-content: center;
        }

        .pill {
            padding: 5px 11px;
            border-radius: 999px;
            font-size: 13px;
            background: rgba(15,118,110,0.12);
            color: var(--text-main);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(148,163,184,0.4);
        }

        .pill-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.13em;
            color: var(--text-muted);
        }

        .pill-value {
            font-weight: 600;
        }

        .score-pill {
            background: radial-gradient(circle at top left, rgba(34,197,94,0.28), rgba(22,163,74,0.08));
            border-color: rgba(34,197,94,0.6);
        }

        .level-pill {
            background: radial-gradient(circle at top left, rgba(59,130,246,0.28), rgba(37,99,235,0.08));
            border-color: rgba(59,130,246,0.6);
        }

        .high-pill {
            background: radial-gradient(circle at top left, rgba(250,204,21,0.24), rgba(202,138,4,0.08));
            border-color: rgba(250,204,21,0.6);
        }

        .speed-pill {
            background: radial-gradient(circle at top left, rgba(244,63,94,0.2), rgba(190,24,93,0.08));
            border-color: rgba(244,63,94,0.7);
        }

        #info {
            margin-top: 9px;
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .keys {
            font-family: "Consolas", "SF Mono", monospace;
        }

        .key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(148,163,184,0.5);
            font-size: 11px;
            margin-right: 3px;
            background: rgba(15,23,42,0.9);
            box-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }

        .status {
            text-align: right;
        }

        .status span {
            color: var(--accent-soft);
        }

        /* Overlay */
        #overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        #overlay-inner {
            pointer-events: auto;
            background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
            border-radius: 16px;
            padding: 18px 22px 14px;
            text-align: center;
            box-shadow:
                0 18px 45px rgba(0,0,0,0.9),
                0 0 0 1px rgba(248,250,252,0.12);
            max-width: 280px;
        }

        #overlay-title {
            font-size: 18px;
            margin-bottom: 6px;
            color: var(--danger);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        #overlay-score {
            font-size: 14px;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        #overlay-high {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .name-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        #player-name {
            flex: 1;
            padding: 5px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            background: rgba(15,23,42,0.95);
            color: var(--text-main);
            font-size: 13px;
            outline: none;
        }

        #player-name::placeholder {
            color: rgba(148,163,184,0.7);
        }

        #btn-save {
            border: none;
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
            letter-spacing: 0.03em;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        #btn-save:disabled {
            opacity: 0.6;
            cursor: default;
        }

        #save-status {
            font-size: 11px;
            min-height: 14px;
            margin-bottom: 6px;
        }

        #overlay button#btn-restart {
            border: none;
            padding: 7px 18px;
            border-radius: 999px;
            background: rgba(15,23,42,0.9);
            color: var(--text-main);
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid rgba(148,163,184,0.7);
        }

        /* Leaderboard */
        #leaderboard-card {
            background: rgba(15,23,42,0.96);
            border-radius: 18px;
            padding: 14px 16px 12px;
            box-shadow:
                0 18px 40px rgba(0,0,0,0.8),
                0 0 0 1px rgba(148,163,184,0.25);
            width: 260px;
        }

        #leaderboard-title {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        #leaderboard-table thead th {
            text-align: left;
            padding-bottom: 4px;
            color: var(--text-muted);
            font-weight: 500;
        }

        #leaderboard-table tbody tr {
            border-radius: 10px;
        }

        #leaderboard-table tbody tr:nth-child(odd) {
            background: rgba(15,23,42,0.8);
        }

        #leaderboard-table tbody tr:nth-child(even) {
            background: rgba(15,23,42,0.6);
        }

        #leaderboard-table td {
            padding: 4px 6px;
        }

        .rank-badge {
            font-size: 11px;
            width: 18px;
            text-align: center;
        }

        .rank-1 { color: #facc15; }
        .rank-2 { color: #e5e7eb; }
        .rank-3 { color: #fb923c; }

        .lb-name {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lb-score {
            text-align: right;
            font-weight: 600;
            color: var(--accent-soft);
        }

        .lb-empty {
            font-size: 11px;
            color: var(--text-muted);
            padding-top: 4px;
        }

        /* Login/Kayƒ±t/Men√º Ekranlarƒ± */
        #login-screen, #signup-screen, #menu-screen, #scores-screen, #profile-screen {
            display: none;
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background: radial-gradient(circle at top, #0b1120 0, #000 45%, #020617 100%);
        }

        #login-screen.active, #signup-screen.active, #menu-screen.active, #scores-screen.active, #profile-screen.active {
            display: flex;
        }

        .auth-card {
            background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
            border-radius: 22px;
            padding: 32px 40px;
            box-shadow:
                0 25px 70px rgba(0,0,0,0.85),
                0 0 0 1px rgba(148,163,184,0.15);
            min-width: 400px;
            max-width: 440px;
        }

        .auth-title {
            font-size: 42px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            color: var(--accent);
            letter-spacing: 0.1em;
        }

        .auth-subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 28px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.95);
            color: var(--text-main);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(34,197,94,0.1);
        }

        .form-input.password-input {
            padding-right: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .password-wrapper {
            position: relative;
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .success-message {
            color: var(--accent);
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .auth-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        .auth-button.secondary {
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(148,163,184,0.4);
            color: var(--text-main);
        }

        .auth-button.danger {
            background: linear-gradient(135deg, #f97373, #ef4444);
        }

        .auth-button.secondary:hover {
            background: rgba(15,23,42,1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .menu-welcome {
            text-align: center;
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 24px;
        }

        .menu-username {
            color: var(--accent);
            font-weight: 600;
        }

        #game-layout {
            display: none;
            width: 100%;
            max-width: 100%;
        }

        #game-layout.active {
            display: block;
        }

        /* Ayarlar Ekranƒ± */
        #settings-screen {
            display: none;
            position: fixed;
            inset: 0;
            align-items: flex-start;
            justify-content: center;
            z-index: 1001;
            background: radial-gradient(circle at top, #0b1120 0, #000 45%, #020617 100%);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
        }

        #settings-screen.active {
            display: flex;
        }

        .settings-card {
            background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
            border-radius: 22px;
            padding: 32px 40px;
            box-shadow:
                0 25px 70px rgba(0,0,0,0.85),
                0 0 0 1px rgba(148,163,184,0.15);
            min-width: 400px;
            max-width: 500px;
            width: 100%;
            margin: 20px auto;
        }

        .settings-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
            color: var(--accent);
            letter-spacing: 0.1em;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .control-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.95);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-option:hover {
            background: rgba(15,23,42,1);
            border-color: var(--accent);
        }

        .control-option.selected {
            background: rgba(34,197,94,0.15);
            border-color: var(--accent);
        }

        .control-option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .control-option-label {
            flex: 1;
            color: var(--text-main);
            font-size: 14px;
        }

        .control-option-keys {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .control-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(148,163,184,0.5);
            font-size: 12px;
            background: rgba(15,23,42,0.9);
            color: var(--text-main);
        }

        .settings-button {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .settings-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        .settings-button.secondary {
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(148,163,184,0.4);
            color: var(--text-main);
        }

        .settings-button.secondary:hover {
            background: rgba(15,23,42,1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-settings {
            padding: 5px 11px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.9);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-settings:hover {
            background: rgba(15,23,42,1);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .avatar-option:hover {
            background: rgba(34,197,94,0.2);
            border-color: var(--accent) !important;
            transform: scale(1.1);
        }

        #profile-avatar:hover {
            transform: scale(1.1);
        }

        @media (max-width: 840px) {
            #layout {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Mobil kontrollerin oyun ekranƒ±na gelmemesi i√ßin */
        @media (max-width: 520px) {
            #game-layout {
                overflow: visible;
            }

            #game-wrapper {
                position: relative;
                z-index: 1;
            }
        }

        /* Touch Swipe ƒ∞√ßin */
        #game {
            touch-action: none;
        }

        @media (max-width: 840px) {
            #layout {
                flex-direction: column;
                align-items: center;
            }

            #leaderboard-card {
                width: 100%;
                max-width: 400px;
                margin-top: 20px;
            }

            #game-wrapper {
                width: 100%;
                max-width: 400px;
            }

            canvas {
                width: 100%;
                height: auto;
                max-width: 400px;
                max-height: 400px;
            }
        }

        @media (max-width: 520px) {
            h1 {
                font-size: 20px;
                margin-top: 12px;
                margin-bottom: 4px;
            }

            .subtitle {
                font-size: 11px;
                padding: 0 10px;
                margin-bottom: 12px;
            }

            body {
                padding-bottom: 20px;
            }

            #game-layout {
                padding-bottom: 20px;
            }

            #layout {
                margin-top: 12px;
                gap: 12px;
                padding-bottom: 0;
                margin-bottom: 0;
            }


            .auth-card, .settings-card {
                min-width: auto;
                width: 90%;
                max-width: 100%;
                padding: 24px 20px;
            }

            #game-wrapper {
                padding: 10px;
                margin-bottom: 0;
                max-width: 100%;
            }

            #game-wrapper canvas {
                margin: 0 auto;
            }

            #game-card {
                padding: 8px 10px;
            }

            canvas {
                max-width: 100%;
                max-height: 280px;
                width: auto;
                height: auto;
                aspect-ratio: 1;
            }

            #hud {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 8px;
                font-size: 11px;
            }

            .hud-left, .hud-right {
                flex: 1;
                min-width: 0;
            }

            .hud-center {
                width: 100%;
                order: 3;
                margin-top: 4px;
            }

            #leaderboard-card {
                width: 100%;
                max-width: 100%;
                margin-top: 12px;
                margin-bottom: 0;
                display: none; /* Mobilde leaderboard'u gizle, yer tasarrufu i√ßin */
            }

            .pill {
                font-size: 10px;
                padding: 3px 6px;
            }

            #info {
                font-size: 10px;
                margin-top: 6px;
                flex-direction: column;
                gap: 4px;
            }

            .keys {
                font-size: 9px;
            }
        }

        @media (max-width: 400px) {
            h1 {
                font-size: 18px;
                margin-top: 10px;
            }

            .subtitle {
                font-size: 10px;
            }

            canvas {
                max-width: 100%;
                max-height: 280px;
            }

            #game-wrapper {
                padding: 8px;
            }

            #game-card {
                padding: 6px 8px;
            }


            .pill {
                font-size: 9px;
                padding: 2px 5px;
            }

            #hud {
                font-size: 10px;
            }
        }

    </style>
</head>
<body>
    <!-- Login Ekranƒ± -->
    <div id="login-screen" class="active">
        <div class="auth-card">
            <div class="auth-title">SNAKE</div>
            <div class="auth-subtitle">Devam etmek i√ßin giri≈ü yap</div>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="login-username" class="form-input" maxlength="24" autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">≈ûifre</label>
                    <div class="password-wrapper">
                        <input type="password" id="login-password" class="form-input password-input" maxlength="24" autocomplete="current-password">
                        <button type="button" class="password-toggle" id="login-password-toggle">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="error-message" id="login-error"></div>
                <div class="button-group">
                    <button type="submit" class="auth-button">Giri≈ü Yap</button>
                    <button type="button" class="auth-button secondary" id="btn-signup">Kayƒ±t Ol</button>
                    <button type="button" class="auth-button secondary" id="btn-guest">Misafir Olarak Devam Et</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kayƒ±t Ekranƒ± -->
    <div id="signup-screen">
        <div class="auth-card">
            <div class="auth-title">Kayƒ±t Ol</div>
            <form id="signup-form">
                <div class="form-group">
                    <label class="form-label">Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="signup-username" class="form-input" maxlength="24" autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">≈ûifre</label>
                    <div class="password-wrapper">
                        <input type="password" id="signup-password" class="form-input password-input" maxlength="24" autocomplete="new-password">
                        <button type="button" class="password-toggle" id="signup-password-toggle">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">≈ûifre (Tekrar)</label>
                    <div class="password-wrapper">
                        <input type="password" id="signup-password-confirm" class="form-input password-input" maxlength="24" autocomplete="new-password">
                        <button type="button" class="password-toggle" id="signup-password-confirm-toggle">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="error-message" id="signup-error"></div>
                <div class="success-message" id="signup-success"></div>
                <div class="button-group">
                    <button type="submit" class="auth-button">Hesap Olu≈ütur</button>
                    <button type="button" class="auth-button secondary" id="btn-back-login">Geri D√∂n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Men√º Ekranƒ± -->
    <div id="menu-screen">
        <div class="auth-card">
            <div class="auth-title">SNAKE</div>
            <div class="menu-welcome">Ho≈ü geldin, <span class="menu-username" id="menu-username"></span></div>
            <div class="button-group">
                <button type="button" class="auth-button" id="btn-start-game">Oyuna Ba≈üla</button>
                <button type="button" class="auth-button secondary" id="btn-view-profile">Profil</button>
                <button type="button" class="auth-button secondary" id="btn-view-scores">En Y√ºksek Skorlar</button>
                <button type="button" class="auth-button danger" id="btn-logout">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>
    </div>

    <!-- Ayarlar Ekranƒ± -->
    <div id="settings-screen">
        <div class="settings-card">
            <div class="settings-title">‚öôÔ∏è Ayarlar</div>
            
            <div class="settings-section">
                <div class="settings-section-title">Kontroller</div>
                <div class="control-option" data-control="arrows">
                    <input type="radio" name="controls" id="control-arrows" value="arrows" checked>
                    <label for="control-arrows" class="control-option-label">
                        <div>Y√∂n Tu≈ülarƒ±</div>
                        <div class="control-option-keys" style="margin-top: 4px;">
                            <span class="control-key">‚Üë</span>
                            <span class="control-key">‚Üì</span>
                            <span class="control-key">‚Üê</span>
                            <span class="control-key">‚Üí</span>
                        </div>
                    </label>
                </div>
                <div class="control-option" data-control="wasd">
                    <input type="radio" name="controls" id="control-wasd" value="wasd">
                    <label for="control-wasd" class="control-option-label">
                        <div>WASD Tu≈ülarƒ±</div>
                        <div class="control-option-keys" style="margin-top: 4px;">
                            <span class="control-key">W</span>
                            <span class="control-key">S</span>
                            <span class="control-key">A</span>
                            <span class="control-key">D</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Oyun Modu</div>
                <div class="control-option" data-mode="klasik">
                    <input type="radio" name="gamemode" id="mode-klasik" value="klasik" checked>
                    <label for="mode-klasik" class="control-option-label">
                        <div>Klasik</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Duvardan ge√ßer, kendi kuyruƒüuna √ßarpƒ±nca √∂l√ºr</div>
                    </label>
                </div>
                <div class="control-option" data-mode="duvarlƒ±">
                    <input type="radio" name="gamemode" id="mode-duvarlƒ±" value="duvarlƒ±">
                    <label for="mode-duvarlƒ±" class="control-option-label">
                        <div>Duvarlƒ±</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Sƒ±nƒ±rdan √ßarpƒ±nca oyun biter</div>
                    </label>
                </div>
                <div class="control-option" data-mode="hƒ±zlƒ±">
                    <input type="radio" name="gamemode" id="mode-hƒ±zlƒ±" value="hƒ±zlƒ±">
                    <label for="mode-hƒ±zlƒ±" class="control-option-label">
                        <div>Hƒ±zlƒ±</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">%35 daha hƒ±zlƒ± hareket eder</div>
                    </label>
                </div>
                <div class="control-option" data-mode="random">
                    <input type="radio" name="gamemode" id="mode-random" value="random">
                    <label for="mode-random" class="control-option-label">
                        <div>Random Harita</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Rastgele engeller ve duvar bloklarƒ±</div>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Tema</div>
                <div class="control-option" data-theme="neon">
                    <input type="radio" name="theme" id="theme-neon" value="neon" checked>
                    <label for="theme-neon" class="control-option-label">
                        <div>Neon</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Parlak renkler ve neon efektleri</div>
                    </label>
                </div>
                <div class="control-option" data-theme="retro">
                    <input type="radio" name="theme" id="theme-retro" value="retro">
                    <label for="theme-retro" class="control-option-label">
                        <div>Retro</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Pixel/Arcade tarzƒ± g√∂r√ºn√ºm</div>
                    </label>
                </div>
                <div class="control-option" data-theme="minimal">
                    <input type="radio" name="theme" id="theme-minimal" value="minimal">
                    <label for="theme-minimal" class="control-option-label">
                        <div>Minimal</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Sade ve d√ºz tasarƒ±m</div>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Ses</div>
                <div class="control-option" style="cursor: pointer;" id="sound-toggle-option">
                    <input type="checkbox" id="sound-toggle" checked style="margin-right: 12px; cursor: pointer;">
                    <label for="sound-toggle" class="control-option-label" style="cursor: pointer; flex: 1;">
                        <div>Ses Efektleri</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Elma yeme, √ßarpma ve level-up sesleri</div>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="settings-button" id="btn-settings-close">Kaydet ve Kapat</button>
                <button type="button" class="settings-button secondary" id="btn-settings-menu">Men√ºye D√∂n</button>
            </div>
        </div>
    </div>

    <!-- Skorlar Ekranƒ± -->
    <div id="scores-screen">
        <div class="auth-card" style="max-width: 520px; max-height: 80vh; overflow-y: auto;">
            <div class="auth-title" style="font-size: 24px; margin-bottom: 16px;">En Y√ºksek Skorlar</div>
            <div id="scores-list" style="margin-bottom: 16px;">
                <table id="scores-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(148,163,184,0.3);">
                            <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 12px;">#</th>
                            <th style="text-align: left; padding: 8px; color: var(--text-muted); font-size: 12px;">Oyuncu</th>
                            <th style="text-align: right; padding: 8px; color: var(--text-muted); font-size: 12px;">Skor</th>
                        </tr>
                    </thead>
                    <tbody id="scores-body">
                    </tbody>
                </table>
            </div>
            <button type="button" class="auth-button secondary" id="btn-back-menu">Geri D√∂n</button>
        </div>
    </div>

    <!-- Profil Ekranƒ± -->
    <div id="profile-screen">
        <div class="auth-card" style="max-width: 520px; max-height: 90vh; overflow-y: auto;">
            <div class="auth-title" style="font-size: 28px; margin-bottom: 24px;">üë§ Profil</div>
            
            <div id="profile-content" style="text-align: center;">
                <div id="profile-loading" style="color: var(--text-muted); padding: 40px;">
                    Y√ºkleniyor...
                </div>
                
                <div id="profile-info" style="display: none;">
                    <!-- Avatar -->
                    <div style="margin-bottom: 24px;">
                        <div id="profile-avatar" style="font-size: 80px; margin-bottom: 12px; cursor: pointer; display: inline-block; transition: transform 0.2s;" title="Avatar'ƒ± deƒüi≈ütirmek i√ßin tƒ±klayƒ±n">
                            üêç
                        </div>
                        <div id="avatar-selector" style="display: none; margin-top: 12px;">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px;">
                                <span class="avatar-option" data-avatar="üêç" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">üêç</span>
                                <span class="avatar-option" data-avatar="üêâ" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">üêâ</span>
                                <span class="avatar-option" data-avatar="üê≤" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">üê≤</span>
                                <span class="avatar-option" data-avatar="ü¶é" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">ü¶é</span>
                                <span class="avatar-option" data-avatar="üê∏" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">üê∏</span>
                                <span class="avatar-option" data-avatar="ü¶ñ" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">ü¶ñ</span>
                                <span class="avatar-option" data-avatar="‚≠ê" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">‚≠ê</span>
                                <span class="avatar-option" data-avatar="üî•" style="font-size: 32px; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;">üî•</span>
                            </div>
                            <button type="button" class="auth-button secondary" id="btn-avatar-cancel" style="width: auto; padding: 8px 16px; font-size: 12px;">ƒ∞ptal</button>
                        </div>
                    </div>
                    
                    <!-- Kullanƒ±cƒ± Adƒ± -->
                    <div style="margin-bottom: 24px;">
                        <div class="form-label">Kullanƒ±cƒ± Adƒ±</div>
                        <div id="profile-username" style="font-size: 24px; font-weight: 600; color: var(--accent);">-</div>
                    </div>
                    
                    <!-- ƒ∞statistikler -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: rgba(15,23,42,0.95); border-radius: 12px; padding: 16px; border: 1px solid rgba(148,163,184,0.3);">
                            <div class="form-label" style="margin-bottom: 8px;">En Y√ºksek Skor</div>
                            <div id="profile-highest-score" style="font-size: 28px; font-weight: 700; color: var(--accent-soft);">0</div>
                        </div>
                        <div style="background: rgba(15,23,42,0.95); border-radius: 12px; padding: 16px; border: 1px solid rgba(148,163,184,0.3);">
                            <div class="form-label" style="margin-bottom: 8px;">Toplam Oyun</div>
                            <div id="profile-total-games" style="font-size: 28px; font-weight: 700; color: var(--accent-soft);">0</div>
                        </div>
                        <div style="background: rgba(15,23,42,0.95); border-radius: 12px; padding: 16px; border: 1px solid rgba(148,163,184,0.3);">
                            <div class="form-label" style="margin-bottom: 8px;">Ortalama Skor</div>
                            <div id="profile-average-score" style="font-size: 28px; font-weight: 700; color: var(--accent-soft);">0</div>
                        </div>
                        <div style="background: rgba(15,23,42,0.95); border-radius: 12px; padding: 16px; border: 1px solid rgba(148,163,184,0.3);">
                            <div class="form-label" style="margin-bottom: 8px;">√úyelik Tarihi</div>
                            <div id="profile-created-at" style="font-size: 14px; color: var(--text-main);">-</div>
                        </div>
                    </div>
                    
                    <!-- Son Skorlar -->
                    <div style="margin-bottom: 24px;">
                        <div class="form-label" style="text-align: left; margin-bottom: 12px;">Son 10 Skor</div>
                        <div id="profile-recent-scores" style="background: rgba(15,23,42,0.95); border-radius: 12px; padding: 12px; border: 1px solid rgba(148,163,184,0.3); max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">
                                Hen√ºz skor yok
                            </div>
                        </div>
                    </div>
                    
                    <div class="error-message" id="profile-error"></div>
                    <div class="success-message" id="profile-success"></div>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button type="button" class="auth-button secondary" id="btn-profile-back-menu">Geri D√∂n</button>
            </div>
        </div>
    </div>

    <!-- Oyun Ekranƒ± -->
    <div id="game-layout">
        <h1>
            Yƒ±lan Oyunu
            <span class="logo-icon">üß¨</span>
        </h1>
        <div class="subtitle">Neon grid, patlama efektleri ve online skor tablosu ile mini arcade oyunun ‚ú®</div>

        <div id="layout">
        <!-- Oyun -->
        <div id="game-wrapper">
            <div id="game-card">
                <div style="position:relative; display:inline-block;">
                    <canvas id="game" width="400" height="400"></canvas>

                    <!-- Game over / pause overlay -->
                    <div id="overlay">
                        <div id="overlay-inner">
                            <div id="overlay-title">Oyun Bitti</div>
                            <div id="overlay-score"></div>
                            <div id="overlay-high"></div>

                            <div class="name-row" id="name-row">
                                <input id="player-name" type="text" maxlength="20"
                                       placeholder="ƒ∞smini yaz (√∂rn. Mert)">
                                <button id="btn-save">Kaydet</button>
                            </div>
                            <div id="save-status"></div>

                            <div style="display: flex; gap: 8px; flex-direction: column;">
                                <button id="btn-restart">Yeniden Ba≈ülat (R)</button>
                                <button id="btn-menu" class="auth-button secondary" style="margin-top: 0;">Men√ºye D√∂n</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="hud">
                    <div class="hud-left">
                        <div class="pill score-pill">
                            <span class="pill-label">Skor</span>
                            <span class="pill-value" id="score-value">0</span>
                        </div>
                        <div class="pill level-pill">
                            <span class="pill-label">Level</span>
                            <span class="pill-value" id="level-value">1</span>
                        </div>
                        <div class="pill" id="lives-pill" style="background: radial-gradient(circle at top left, rgba(244,63,94,0.28), rgba(190,24,93,0.08)); border-color: rgba(244,63,94,0.6);">
                            <span class="pill-label">Can</span>
                            <span class="pill-value" id="lives-value">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                        </div>
                    </div>
                    <div class="hud-center">
                        <button class="btn-settings" id="btn-settings">‚öôÔ∏è Ayarlar</button>
                    </div>
                    <div class="hud-right">
                        <div class="pill high-pill">
                            <span class="pill-label" id="high-label">En Y√ºksek</span>
                            <span class="pill-value" id="high-value">0</span>
                        </div>
                        <div class="pill speed-pill">
                            <span class="pill-label">Hƒ±z</span>
                            <span class="pill-value" id="speed-label">Normal</span>
                        </div>
                    </div>
                </div>

                <div id="info">
                    <div class="keys" id="control-info">
                        <span class="key">‚Üë</span>
                        <span class="key">‚Üì</span>
                        <span class="key">‚Üê</span>
                        <span class="key">‚Üí</span>
                        ile hareket ‚Ä¢ <span class="key">P</span> duraklat ‚Ä¢ <span class="key">R</span> yeniden
                    </div>
                    <div class="status">
                        <span>Level arttƒ±k√ßa hƒ±z ve renkler deƒüi≈üir.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-card">
            <div id="leaderboard-title">En iyi 10 skor</div>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Oyuncu</th>
                        <th>Skor</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- JS ile doldurulacak -->
                </tbody>
            </table>
            <div id="leaderboard-empty" class="lb-empty" style="display:none;">
                Hen√ºz kayƒ±tlƒ± skor yok. ƒ∞lk sen ol! üöÄ
            </div>
        </div>
    </div>

    </div>

    <script>
        // ========== AUTH STATE ==========
        let currentUsername = "";
        let guestMode = false;
        let currentScreen = "login"; // login, signup, menu, scores, game, settings

        // ========== THEME SYSTEM ==========
        let currentTheme = localStorage.getItem("snake_theme") || "neon"; // "neon", "retro", "minimal"
        
        function applyTheme(theme) {
            // T√ºm tema class'larƒ±nƒ± kaldƒ±r
            document.body.classList.remove("theme-neon", "theme-retro", "theme-minimal");
            // Yeni temayƒ± ekle
            document.body.classList.add(`theme-${theme}`);
            currentTheme = theme;
            localStorage.setItem("snake_theme", theme);
        }
        
        // Sayfa y√ºklendiƒüinde temayƒ± uygula
        applyTheme(currentTheme);

        // ========== SOUND SYSTEM ==========
        let soundEnabled = localStorage.getItem("snake_sound_enabled") !== "false"; // Varsayƒ±lan a√ßƒ±k
        let soundPlaying = {}; // Spam guard i√ßin
        
        // AudioContext fallback i√ßin
        let audioContext = null;
        function getAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn("AudioContext desteklenmiyor");
                    return null;
                }
            }
            return audioContext;
        }
        
        // Beep sesi √ºret (fallback)
        function generateBeep(frequency, duration, type = "sine") {
            const ctx = getAudioContext();
            if (!ctx) return;
            
            try {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                console.warn("Beep √ºretilemedi:", e);
            }
        }
        
        // Ses dosyasƒ± y√ºkleme (fallback ile)
        function playSound(soundName) {
            if (!soundEnabled) return;
            
            // Spam guard: Aynƒ± ses √ßok hƒ±zlƒ± tekrar √ßalƒ±nmasƒ±n
            const now = Date.now();
            if (soundPlaying[soundName] && now - soundPlaying[soundName] < 50) {
                return;
            }
            soundPlaying[soundName] = now;
            
            // Ses dosyasƒ±nƒ± y√ºkle
            const audio = new Audio(`/static/sounds/${soundName}.mp3`);
            
            audio.volume = 0.5;
            
            audio.play().catch(err => {
                // Ses dosyasƒ± yoksa veya √ßalƒ±namazsa beep fallback kullan
                console.log(`Ses dosyasƒ± y√ºklenemedi (${soundName}), beep kullanƒ±lƒ±yor`);
                
                if (soundName === "eat") {
                    generateBeep(800, 0.1, "sine");
                } else if (soundName === "hit") {
                    generateBeep(200, 0.2, "sawtooth");
                } else if (soundName === "level") {
                    generateBeep(600, 0.15, "sine");
                    setTimeout(() => generateBeep(800, 0.15, "sine"), 100);
                }
            });
        }
        
        // Ses ayarƒ±nƒ± g√ºncelle
        function updateSoundSetting(enabled) {
            soundEnabled = enabled;
            localStorage.setItem("snake_sound_enabled", enabled ? "true" : "false");
            const soundToggle = document.getElementById("sound-toggle");
            if (soundToggle) {
                soundToggle.checked = enabled;
            }
        }

        // ========== CONTROL SYSTEM ==========
        let controlScheme = localStorage.getItem("snakeControlScheme") || "arrows"; // "arrows" veya "wasd"
        
        // ========== GAME MODE SYSTEM ==========
        let gameMode = localStorage.getItem("snakeGameMode") || "klasik"; // "klasik", "duvarlƒ±", "hƒ±zlƒ±", "random"
        let obstacles = []; // Random harita modu i√ßin engeller

        function updateControlInfo() {
            const controlInfo = document.getElementById("control-info");
            if (controlScheme === "wasd") {
                controlInfo.innerHTML = `
                    <span class="key">W</span>
                    <span class="key">S</span>
                    <span class="key">A</span>
                    <span class="key">D</span>
                    ile hareket ‚Ä¢ <span class="key">P</span> duraklat ‚Ä¢ <span class="key">R</span> yeniden
                `;
            } else {
                controlInfo.innerHTML = `
                    <span class="key">‚Üë</span>
                    <span class="key">‚Üì</span>
                    <span class="key">‚Üê</span>
                    <span class="key">‚Üí</span>
                    ile hareket ‚Ä¢ <span class="key">P</span> duraklat ‚Ä¢ <span class="key">R</span> yeniden
                `;
            }
        }

        // Ba≈ülangƒ±√ßta kontrol bilgisini g√ºncelle
        updateControlInfo();

        // ========== SCREEN MANAGEMENT ==========
        function showScreen(screenName) {
            document.getElementById("login-screen").classList.remove("active");
            document.getElementById("signup-screen").classList.remove("active");
            document.getElementById("menu-screen").classList.remove("active");
            document.getElementById("scores-screen").classList.remove("active");
            document.getElementById("profile-screen").classList.remove("active");
            document.getElementById("game-layout").classList.remove("active");
            document.getElementById("settings-screen").classList.remove("active");

            if (screenName === "login") {
                document.getElementById("login-screen").classList.add("active");
            } else if (screenName === "signup") {
                document.getElementById("signup-screen").classList.add("active");
            } else if (screenName === "menu") {
                document.getElementById("menu-screen").classList.add("active");
                document.getElementById("menu-username").textContent = currentUsername || "Misafir";
            } else if (screenName === "scores") {
                document.getElementById("scores-screen").classList.add("active");
                loadScoresPage();
            } else if (screenName === "profile") {
                document.getElementById("profile-screen").classList.add("active");
                loadProfilePage();
            } else if (screenName === "game") {
                document.getElementById("game-layout").classList.add("active");
            } else if (screenName === "settings") {
                document.getElementById("settings-screen").classList.add("active");
                updateSettingsDisplay();
            }
            currentScreen = screenName;
        }

        function updateSettingsDisplay() {
            // Kontrol se√ßeneƒüini g√ºncelle
            const arrowsOption = document.getElementById("control-arrows");
            const wasdOption = document.getElementById("control-wasd");
            const arrowsDiv = document.querySelector('[data-control="arrows"]');
            const wasdDiv = document.querySelector('[data-control="wasd"]');
            
            if (controlScheme === "arrows") {
                arrowsOption.checked = true;
                arrowsDiv.classList.add("selected");
                wasdDiv.classList.remove("selected");
            } else {
                wasdOption.checked = true;
                wasdDiv.classList.add("selected");
                arrowsDiv.classList.remove("selected");
            }
            
            // Oyun modu se√ßeneƒüini g√ºncelle
            const modeOptions = document.querySelectorAll('input[name="gamemode"]');
            const modeDivs = document.querySelectorAll('[data-mode]');
            modeDivs.forEach(div => div.classList.remove("selected"));
            
            modeOptions.forEach(option => {
                if (option.value === gameMode) {
                    option.checked = true;
                    const modeDiv = document.querySelector(`[data-mode="${gameMode}"]`);
                    if (modeDiv) modeDiv.classList.add("selected");
                }
            });
            
            // Tema se√ßeneƒüini g√ºncelle
            const themeOptions = document.querySelectorAll('input[name="theme"]');
            const themeDivs = document.querySelectorAll('[data-theme]');
            themeDivs.forEach(div => div.classList.remove("selected"));
            
            themeOptions.forEach(option => {
                if (option.value === currentTheme) {
                    option.checked = true;
                    const themeDiv = document.querySelector(`[data-theme="${currentTheme}"]`);
                    if (themeDiv) themeDiv.classList.add("selected");
                }
            });
            
            // Ses ayarƒ±nƒ± g√ºncelle
            const soundToggle = document.getElementById("sound-toggle");
            if (soundToggle) {
                soundToggle.checked = soundEnabled;
            }
        }

        // ========== PASSWORD TOGGLE ==========
        function setupPasswordToggle(toggleId, inputId) {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);
            if (toggle && input) {
                toggle.addEventListener("click", () => {
                    if (input.type === "password") {
                        input.type = "text";
                        toggle.textContent = "üôà";
                    } else {
                        input.type = "password";
                        toggle.textContent = "üëÅÔ∏è";
                    }
                });
            }
        }

        setupPasswordToggle("login-password-toggle", "login-password");
        setupPasswordToggle("signup-password-toggle", "signup-password");
        setupPasswordToggle("signup-password-confirm-toggle", "signup-password-confirm");

        // ========== API FUNCTIONS ==========
        async function loginUser(username, password) {
            try {
                const res = await fetch("/api/auth/login/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                return data;
            } catch (err) {
                return { ok: false, message: "Baƒülantƒ± hatasƒ±" };
            }
        }

        async function registerUser(username, password) {
            try {
                const res = await fetch("/api/auth/register/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                return data;
            } catch (err) {
                return { ok: false, message: "Baƒülantƒ± hatasƒ±" };
            }
        }

        // ========== LOGIN FORM ==========
        document.getElementById("login-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("login-username").value.trim();
            const password = document.getElementById("login-password").value;
            const errorEl = document.getElementById("login-error");

            if (!username || !password) {
                errorEl.textContent = "Kullanƒ±cƒ± adƒ± ve ≈üifre girin";
                return;
            }

            errorEl.textContent = "";
            const result = await loginUser(username, password);

            if (result.ok) {
                currentUsername = username;
                guestMode = false;
                showScreen("menu");
            } else {
                errorEl.textContent = result.message || "Giri≈ü ba≈üarƒ±sƒ±z";
            }
        });

        document.getElementById("btn-signup").addEventListener("click", () => {
            showScreen("signup");
        });

        document.getElementById("btn-guest").addEventListener("click", () => {
            currentUsername = "Misafir";
            guestMode = true;
            showScreen("game");
            resetGame();
        });

        // ========== SIGNUP FORM ==========
        document.getElementById("signup-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("signup-username").value.trim();
            const password = document.getElementById("signup-password").value;
            const passwordConfirm = document.getElementById("signup-password-confirm").value;
            const errorEl = document.getElementById("signup-error");
            const successEl = document.getElementById("signup-success");

            errorEl.textContent = "";
            successEl.textContent = "";

            if (!username || !password || !passwordConfirm) {
                errorEl.textContent = "T√ºm alanlarƒ± doldurun";
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = "≈ûifreler e≈üle≈ümiyor";
                return;
            }

            const result = await registerUser(username, password);

            if (result.ok) {
                successEl.textContent = "Hesap olu≈üturuldu! Giri≈ü ekranƒ±na y√∂nlendiriliyorsunuz...";
                document.getElementById("login-username").value = username;
                setTimeout(() => {
                    showScreen("login");
                    document.getElementById("signup-username").value = "";
                    document.getElementById("signup-password").value = "";
                    document.getElementById("signup-password-confirm").value = "";
                }, 1500);
            } else {
                errorEl.textContent = result.message || "Kayƒ±t ba≈üarƒ±sƒ±z";
            }
        });

        document.getElementById("btn-back-login").addEventListener("click", () => {
            showScreen("login");
        });

        // ========== MENU ==========
        document.getElementById("btn-start-game").addEventListener("click", () => {
            showScreen("game");
            resetGame();
            // Oyun ba≈üladƒ±ƒüƒ±nda en y√ºksek skoru g√ºncelle
            loadHighestScore();
        });

        document.getElementById("btn-view-profile").addEventListener("click", () => {
            if (guestMode || !currentUsername) {
                alert("Profil sayfasƒ±nƒ± g√∂rmek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.");
                return;
            }
            showScreen("profile");
        });

        document.getElementById("btn-view-scores").addEventListener("click", () => {
            showScreen("scores");
        });

        document.getElementById("btn-logout").addEventListener("click", () => {
            currentUsername = "";
            guestMode = false;
            showScreen("login");
            document.getElementById("login-username").value = "";
            document.getElementById("login-password").value = "";
        });

        // ========== SCORES PAGE ==========
        document.getElementById("btn-back-menu").addEventListener("click", () => {
            showScreen("menu");
        });

        // ========== PROFILE PAGE ==========
        document.getElementById("btn-profile-back-menu").addEventListener("click", () => {
            showScreen("menu");
        });

        async function loadProfilePage() {
            const loadingEl = document.getElementById("profile-loading");
            const infoEl = document.getElementById("profile-info");
            const errorEl = document.getElementById("profile-error");
            const successEl = document.getElementById("profile-success");
            
            loadingEl.style.display = "block";
            infoEl.style.display = "none";
            errorEl.textContent = "";
            successEl.textContent = "";
            
            try {
                const res = await fetch(`/api/profile/?username=${encodeURIComponent(currentUsername)}`);
                if (!res.ok) throw new Error("http");
                const data = await res.json();
                
                if (!data.ok) {
                    throw new Error(data.message || "Profil y√ºklenemedi");
                }
                
                const profile = data.profile;
                
                // Profil bilgilerini doldur
                document.getElementById("profile-username").textContent = profile.username;
                document.getElementById("profile-avatar").textContent = profile.avatar || "üêç";
                document.getElementById("profile-highest-score").textContent = profile.highest_score || 0;
                document.getElementById("profile-total-games").textContent = profile.total_games || 0;
                document.getElementById("profile-average-score").textContent = profile.average_score || 0;
                
                // Tarih formatla
                if (profile.created_at) {
                    const date = new Date(profile.created_at);
                    const formattedDate = date.toLocaleDateString("tr-TR", {
                        year: "numeric",
                        month: "long",
                        day: "numeric"
                    });
                    document.getElementById("profile-created-at").textContent = formattedDate;
                }
                
                // Son skorlarƒ± g√∂ster
                const recentScoresEl = document.getElementById("profile-recent-scores");
                if (profile.recent_scores && profile.recent_scores.length > 0) {
                    recentScoresEl.innerHTML = profile.recent_scores.map((score, index) => {
                        const date = new Date(score.created_at);
                        const formattedDate = date.toLocaleDateString("tr-TR", {
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit"
                        });
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                                <div>
                                    <span style="color: var(--text-muted); font-size: 11px;">${formattedDate}</span>
                                </div>
                                <div style="font-weight: 600; color: var(--accent-soft);">${score.value}</div>
                            </div>
                        `;
                    }).join("");
                } else {
                    recentScoresEl.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">Hen√ºz skor yok</div>';
                }
                
                loadingEl.style.display = "none";
                infoEl.style.display = "block";
            } catch (err) {
                loadingEl.style.display = "none";
                errorEl.textContent = "Profil y√ºklenirken hata olu≈ütu: " + (err.message || "Bilinmeyen hata");
            }
        }

        // Avatar g√ºncelleme
        let selectedAvatar = null;
        const profileAvatar = document.getElementById("profile-avatar");
        const avatarSelector = document.getElementById("avatar-selector");
        const avatarOptions = document.querySelectorAll(".avatar-option");
        const btnAvatarCancel = document.getElementById("btn-avatar-cancel");

        profileAvatar.addEventListener("click", () => {
            if (guestMode || !currentUsername) return;
            avatarSelector.style.display = avatarSelector.style.display === "none" ? "block" : "none";
        });

        avatarOptions.forEach(option => {
            option.addEventListener("click", async () => {
                selectedAvatar = option.getAttribute("data-avatar");
                profileAvatar.textContent = selectedAvatar;
                
                // API'ye g√∂nder
                try {
                    const res = await fetch("/api/profile/avatar/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username: currentUsername, avatar: selectedAvatar })
                    });
                    const data = await res.json();
                    
                    if (data.ok) {
                        document.getElementById("profile-success").textContent = "Avatar g√ºncellendi! ‚úÖ";
                        setTimeout(() => {
                            document.getElementById("profile-success").textContent = "";
                        }, 3000);
                    } else {
                        document.getElementById("profile-error").textContent = data.message || "Avatar g√ºncellenemedi";
                    }
                } catch (err) {
                    document.getElementById("profile-error").textContent = "Baƒülantƒ± hatasƒ±";
                }
                
                avatarSelector.style.display = "none";
            });
        });

        btnAvatarCancel.addEventListener("click", () => {
            avatarSelector.style.display = "none";
        });

        // ========== SETTINGS ==========
        document.getElementById("btn-settings").addEventListener("click", () => {
            showScreen("settings");
        });

        document.getElementById("btn-settings-close").addEventListener("click", () => {
            // Kontrol se√ßeneƒüini kaydet
            const selectedControl = document.querySelector('input[name="controls"]:checked');
            if (selectedControl) {
                controlScheme = selectedControl.value;
                localStorage.setItem("snakeControlScheme", controlScheme);
                updateControlInfo();
            }
            // Oyun modu se√ßeneƒüini kaydet
            const selectedMode = document.querySelector('input[name="gamemode"]:checked');
            if (selectedMode) {
                gameMode = selectedMode.value;
                localStorage.setItem("snakeGameMode", gameMode);
            }
            // Tema se√ßeneƒüini kaydet ve uygula
            const selectedTheme = document.querySelector('input[name="theme"]:checked');
            if (selectedTheme) {
                applyTheme(selectedTheme.value);
            }
            // Ses ayarƒ±nƒ± kaydet
            const soundToggle = document.getElementById("sound-toggle");
            if (soundToggle) {
                updateSoundSetting(soundToggle.checked);
            }
            showScreen("game");
        });

        document.getElementById("btn-settings-menu").addEventListener("click", () => {
            // Kontrol se√ßeneƒüini kaydet
            const selectedControl = document.querySelector('input[name="controls"]:checked');
            if (selectedControl) {
                controlScheme = selectedControl.value;
                localStorage.setItem("snakeControlScheme", controlScheme);
                updateControlInfo();
            }
            // Oyun modu se√ßeneƒüini kaydet
            const selectedMode = document.querySelector('input[name="gamemode"]:checked');
            if (selectedMode) {
                gameMode = selectedMode.value;
                localStorage.setItem("snakeGameMode", gameMode);
            }
            // Tema se√ßeneƒüini kaydet ve uygula
            const selectedTheme = document.querySelector('input[name="theme"]:checked');
            if (selectedTheme) {
                applyTheme(selectedTheme.value);
            }
            // Ses ayarƒ±nƒ± kaydet
            const soundToggle = document.getElementById("sound-toggle");
            if (soundToggle) {
                updateSoundSetting(soundToggle.checked);
            }
            showScreen("menu");
        });
        
        // Ses toggle deƒüi≈üikliƒüi
        const soundToggle = document.getElementById("sound-toggle");
        if (soundToggle) {
            soundToggle.addEventListener("change", (e) => {
                updateSoundSetting(e.target.checked);
            });
        }

        // Kontrol se√ßeneklerini deƒüi≈ütir
        document.querySelectorAll('input[name="controls"]').forEach(radio => {
            radio.addEventListener("change", () => {
                document.querySelectorAll('[data-control]').forEach(opt => {
                    opt.classList.remove("selected");
                });
                const selectedDiv = document.querySelector(`[data-control="${radio.value}"]`);
                if (selectedDiv) {
                    selectedDiv.classList.add("selected");
                }
            });
        });
        
        // Oyun modu se√ßeneklerini deƒüi≈ütir
        document.querySelectorAll('input[name="gamemode"]').forEach(radio => {
            radio.addEventListener("change", () => {
                document.querySelectorAll('[data-mode]').forEach(opt => {
                    opt.classList.remove("selected");
                });
                const selectedDiv = document.querySelector(`[data-mode="${radio.value}"]`);
                if (selectedDiv) {
                    selectedDiv.classList.add("selected");
                }
            });
        });
        
        // Tema se√ßeneklerini deƒüi≈ütir
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener("change", () => {
                document.querySelectorAll('[data-theme]').forEach(opt => {
                    opt.classList.remove("selected");
                });
                const selectedDiv = document.querySelector(`[data-theme="${radio.value}"]`);
                if (selectedDiv) {
                    selectedDiv.classList.add("selected");
                }
                // Tema deƒüi≈ütiƒüinde anƒ±nda uygula (√∂nizleme i√ßin)
                applyTheme(radio.value);
            });
        });

        async function loadScoresPage() {
            const tbody = document.getElementById("scores-body");
            tbody.innerHTML = "";
            try {
                const res = await fetch("/api/score/top/?limit=100");
                if (!res.ok) throw new Error("http");
                const data = await res.json();
                const list = data.results || [];
                
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--text-muted);">Hen√ºz skor yok</td></tr>';
                    return;
                }

                list.forEach((item, index) => {
                    const tr = document.createElement("tr");
                    tr.style.borderBottom = "1px solid rgba(148,163,184,0.1)";
                    tr.innerHTML = `
                        <td style="padding: 8px; color: ${index < 3 ? (index === 0 ? '#facc15' : index === 1 ? '#e5e7eb' : '#fb923c') : 'var(--text-muted)'}">${index + 1}</td>
                        <td style="padding: 8px; color: var(--text-main);">${item.username}</td>
                        <td style="padding: 8px; text-align: right; color: var(--accent-soft); font-weight: 600;">${item.score}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--danger);">Skorlar y√ºklenemedi</td></tr>';
            }
        }

        // ========== GAME CODE ==========
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        const scoreSpan = document.getElementById("score-value");
        const levelSpan = document.getElementById("level-value");
        const highSpan = document.getElementById("high-value");
        const highLabel = document.getElementById("high-label");
        const speedLabel = document.getElementById("speed-label");

        const overlay = document.getElementById("overlay");
        const overlayScore = document.getElementById("overlay-score");
        const overlayHigh = document.getElementById("overlay-high");
        const btnRestart = document.getElementById("btn-restart");
        const btnSave = document.getElementById("btn-save");
        const nameInput = document.getElementById("player-name");
        const saveStatus = document.getElementById("save-status");

        const lbBody = document.getElementById("leaderboard-body");
        const lbEmpty = document.getElementById("leaderboard-empty");

        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        let snake;
        let vx;
        let vy;
        let food;
        let score;
        let level;
        let paused = false;
        let gameOver = false;
        let highScore = Number(localStorage.getItem("snakeHighScoreV3") || 0);
        let dbHighScore = 0; // Veritabanƒ±ndan gelen en y√ºksek skor
        
        // Veritabanƒ±ndan en y√ºksek skoru √ßek
        async function loadHighestScore() {
            try {
                const res = await fetch("/api/score/top/?limit=1");
                if (!res.ok) throw new Error("http");
                const data = await res.json();
                const list = data.results || [];
                
                if (list.length > 0 && list[0].score) {
                    dbHighScore = list[0].score;
                    // Veritabanƒ±ndan gelen skor daha y√ºksekse onu g√∂ster
                    if (dbHighScore > highScore) {
                        highScore = dbHighScore;
                        highSpan.textContent = highScore;
                        if (highLabel) {
                            highLabel.textContent = "En Y√ºksek";
                        }
                    } else {
                        // Local skor daha y√ºksekse onu g√∂ster ama label'ƒ± g√ºncelle
                        highSpan.textContent = highScore;
                        if (highLabel) {
                            highLabel.textContent = highScore > dbHighScore ? "En Y√ºksek (local)" : "En Y√ºksek";
                        }
                    }
                } else {
                    // Veritabanƒ±nda skor yoksa local'i g√∂ster
                    highSpan.textContent = highScore;
                    if (highLabel) {
                        highLabel.textContent = highScore > 0 ? "En Y√ºksek (local)" : "En Y√ºksek";
                    }
                }
            } catch (err) {
                // Hata durumunda local skoru g√∂ster
                highSpan.textContent = highScore;
                if (highLabel) {
                    highLabel.textContent = highScore > 0 ? "En Y√ºksek (local)" : "En Y√ºksek";
                }
            }
        }
        
        // Sayfa y√ºklendiƒüinde en y√ºksek skoru √ßek
        loadHighestScore();

        let particles = [];
        let shakeTime = 0;
        let shakeStrength = 0;

        // Can sistemi
        let lives = 3; // Ba≈ülangƒ±√ß can sayƒ±sƒ±
        let activeTemporaryLives = []; // Aktif s√ºreli canlar
        let temporaryLifeItems = []; // Ekrandaki s√ºreli can √∂ƒüeleri
        let lastScoreForLife = 0; // Her 10 puan i√ßin can kazanmak i√ßin takip
        let tempLifeSpawnTimer = 0; // S√ºreli can olu≈üturma zamanlayƒ±cƒ±sƒ±
        const tempLifeSpawnInterval = 15000; // 15 saniyede bir s√ºreli can (milisaniye)
        const tempLifeDuration = 5000; // S√ºreli can 5 saniye g√∂r√ºn√ºr

        // Yeniden doƒüma sistemi
        let collisionPause = false;
        let collisionResumeTime = 0;
        let collisionGraceActive = false;
        let collisionGraceSteps = 0;
        let previousSnakeBody = null;

        const livesSpan = document.getElementById("lives-value");
        highSpan.textContent = highScore;

        function randomFood() {
            let position;
            let attempts = 0;
            do {
                position = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
                attempts++;
            } while (
                (snake && snake.some(s => s.x === position.x && s.y === position.y)) ||
                (obstacles && obstacles.some(obs => obs.x === position.x && obs.y === position.y)) ||
                attempts < 200
            );
            return position;
        }
        
        function generateObstacles() {
            obstacles = [];
            if (gameMode !== "random") return;
            
            // Yƒ±lanƒ±n ba≈ülangƒ±√ß konumu
            const startPositions = [
                {x: 10, y: 10},
                {x: 9, y: 10},
                {x: 8, y: 10}
            ];
            
            // Toplam engel sayƒ±sƒ± (harita boyutuna g√∂re)
            const obstacleCount = Math.floor((tileCount * tileCount) * 0.15); // %15 engel
            
            for (let i = 0; i < obstacleCount; i++) {
                let position;
                let attempts = 0;
                let valid = false;
                
                do {
                    position = {
                        x: Math.floor(Math.random() * tileCount),
                        y: Math.floor(Math.random() * tileCount)
                    };
                    attempts++;
                    
                    // Yƒ±lanƒ±n ba≈ülangƒ±√ß konumu ile √ßakƒ±≈ümasƒ±n
                    const conflictsWithStart = startPositions.some(
                        pos => pos.x === position.x && pos.y === position.y
                    );
                    
                    // Mevcut engellerle √ßakƒ±≈ümasƒ±n
                    const conflictsWithObstacles = obstacles.some(
                        obs => obs.x === position.x && obs.y === position.y
                    );
                    
                    valid = !conflictsWithStart && !conflictsWithObstacles;
                } while (!valid && attempts < 500);
                
                if (valid) {
                    obstacles.push(position);
                }
            }
        }

        function updateLivesDisplay() {
            const totalLives = Math.min(3, lives + activeTemporaryLives.length); // Maksimum 3 can
            let displayText = "";
            for (let i = 0; i < 3; i++) {
                if (i < totalLives) {
                    displayText += "‚ù§Ô∏è";
                } else {
                    displayText += "ü§ç";
                }
            }
            livesSpan.textContent = displayText;
        }

        function resetGame() {
            snake = [
                {x: 10, y: 10},
                {x: 9,  y: 10},
                {x: 8,  y: 10},
            ];
            vx = 1;
            vy = 0;
            
            // Oyun moduna g√∂re engelleri olu≈ütur
            generateObstacles();
            
            // Yem olu≈ütur (engellerle √ßakƒ±≈ümamasƒ± i√ßin randomFood zaten kontrol ediyor)
            food = randomFood();
            
            score = 0;
            level = 1;
            paused = false;
            gameOver = false;
            particles = [];
            shakeTime = 0;
            lastTickTime = 0; // ƒ∞lk tick hemen √ßalƒ±≈üsƒ±n
            lives = 3; // Canlarƒ± ba≈ülat
            activeTemporaryLives = [];
            temporaryLifeItems = [];
            lastScoreForLife = 0;
            tempLifeSpawnTimer = performance.now();
            collisionPause = false;
            collisionGraceActive = false;
            collisionGraceSteps = 0;
            previousSnakeBody = null;
            scoreSpan.textContent = score;
            levelSpan.textContent = level;
            speedLabel.textContent = "Normal";
            updateLivesDisplay();
            saveStatus.textContent = "";
            btnSave.disabled = false;
            hideOverlay();
            restartLoop();
        }

        function getIntervalByScore(sc) {
            // Yava≈ü ba≈ülangƒ±√ß ve kademeli hƒ±zlanma
            const base = 200; // Ba≈ülangƒ±√ß hƒ±zƒ± daha yava≈ü (200ms)
            // Her 8 puanda 5ms azalt (daha yava≈ü hƒ±zlanma)
            const step = Math.floor(sc / 8) * 5;
            // Minimum 80ms'ye kadar d√º≈üebilir (daha yava≈ü maksimum hƒ±z)
            let interval = Math.max(80, base - step);
            
            // Hƒ±zlƒ± mod: %35 daha hƒ±zlƒ± (interval'i 1.35'e b√∂l)
            if (gameMode === "hƒ±zlƒ±") {
                interval = Math.floor(interval / 1.35);
            }
            
            return interval;
        }

        function updateSpeedUI() {
            const interval = getIntervalByScore(score);
            const relative = 200 - interval; // Base deƒüer 200'e g√ºncellendi
            if (relative <= 10) {
                speedLabel.textContent = "Normal";
            } else if (relative <= 60) {
                speedLabel.textContent = "Hƒ±zlƒ±";
            } else {
                speedLabel.textContent = "√áƒ±lgƒ±n";
            }
        }

        function restartLoop() {
            updateSpeedUI();
        }

        function colorFromLevel(level) {
            const hue = (110 + level * 18) % 360;
            return `hsl(${hue}, 85%, 60%)`;
        }

        function drawBoard() {
            const tile = gridSize;
            
            // Tema bazlƒ± renkler
            let gridColor1, gridColor2, gridLineColor, obstacleColor, obstacleStrokeColor;
            
            if (currentTheme === "retro") {
                gridColor1 = "#0a1628";
                gridColor2 = "#0f1e35";
                gridLineColor = "rgba(83, 52, 131, 0.3)";
                obstacleColor = "rgba(233, 69, 96, 0.5)";
                obstacleStrokeColor = "rgba(233, 69, 96, 0.8)";
            } else if (currentTheme === "minimal") {
                gridColor1 = "#f9fafb";
                gridColor2 = "#ffffff";
                gridLineColor = "rgba(209, 213, 219, 0.5)";
                obstacleColor = "rgba(107, 114, 128, 0.3)";
                obstacleStrokeColor = "rgba(107, 114, 128, 0.6)";
            } else {
                // Neon (varsayƒ±lan)
                gridColor1 = "#11301a";
                gridColor2 = "#17361f";
                gridLineColor = "rgba(34,197,94,0.18)";
                obstacleColor = "rgba(148, 163, 184, 0.4)";
                obstacleStrokeColor = "rgba(148, 163, 184, 0.6)";
            }
            
            for (let x = 0; x < tileCount; x++) {
                for (let y = 0; y < tileCount; y++) {
                    const even = (x + y) % 2 === 0;
                    const base = even ? gridColor1 : gridColor2;
                    ctx.fillStyle = base;
                    ctx.fillRect(x * tile, y * tile, tile, tile);
                }
            }

            ctx.strokeStyle = gridLineColor;
            ctx.lineWidth = 1;
            for (let i = 0; i <= tileCount; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize + 0.5, 0);
                ctx.lineTo(i * gridSize + 0.5, canvas.height);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, i * gridSize + 0.5);
                ctx.lineTo(canvas.width, i * gridSize + 0.5);
                ctx.stroke();
            }
            
            // Random harita modunda engelleri √ßiz
            if (gameMode === "random" && obstacles.length > 0) {
                ctx.fillStyle = obstacleColor;
                ctx.strokeStyle = obstacleStrokeColor;
                ctx.lineWidth = 2;
                
                for (const obstacle of obstacles) {
                    const ox = obstacle.x * gridSize;
                    const oy = obstacle.y * gridSize;
                    
                    // Engeli √ßiz
                    ctx.fillRect(ox + 2, oy + 2, gridSize - 4, gridSize - 4);
                    ctx.strokeRect(ox + 2, oy + 2, gridSize - 4, gridSize - 4);
                    
                    // ƒ∞√ß √ßizgi efekti (sadece neon ve retro temalarda)
                    if (currentTheme !== "minimal") {
                        ctx.strokeStyle = currentTheme === "retro" 
                            ? "rgba(233, 69, 96, 0.3)" 
                            : "rgba(148, 163, 184, 0.3)";
                        ctx.beginPath();
                        ctx.moveTo(ox + 4, oy + 4);
                        ctx.lineTo(ox + gridSize - 4, oy + gridSize - 4);
                        ctx.moveTo(ox + gridSize - 4, oy + 4);
                        ctx.lineTo(ox + 4, oy + gridSize - 4);
                        ctx.stroke();
                        ctx.strokeStyle = obstacleStrokeColor;
                    }
                }
            }
        }

        function spawnParticles(x, y, color) {
            for (let i = 0; i < 12; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 2;
                particles.push({
                    x,
                    y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 18 + Math.random() * 10,
                    color
                });
            }
        }

        function updateParticles() {
            particles = particles.filter(p => p.life > 0);
            for (const p of particles) {
                p.x += p.vx * 0.6;
                p.y += p.vy * 0.6;
                p.vy += 0.02;
                p.life -= 1;
            }
        }

        function drawParticles() {
            for (const p of particles) {
                const alpha = Math.max(0, p.life / 25);
                ctx.fillStyle = p.color.replace(")", `, ${alpha})`).replace("rgb", "rgba");
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2.4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawSnake() {
            let snakeColor = colorFromLevel(level);
            let glowColor = snakeColor.replace("60%", "70%");
            let eyeColor = "#f9fafb";
            let eyePupilColor = "#020617";
            let borderRadius = 6;
            let shadowBlur = 12;
            
            // Tema bazlƒ± ayarlar
            if (currentTheme === "retro") {
                // Retro tema: Daha pixel g√∂r√ºn√ºm, daha az glow
                shadowBlur = 4;
                borderRadius = 0; // Pixel g√∂r√ºn√ºm i√ßin k√∂≈üeler keskin
                eyeColor = "#ffffff";
                eyePupilColor = "#0f1419";
            } else if (currentTheme === "minimal") {
                // Minimal tema: Glow yok, d√ºz renkler
                shadowBlur = 0;
                borderRadius = 4;
                eyeColor = "#ffffff";
                eyePupilColor = "#1f2937";
            }
            
            ctx.shadowColor = glowColor;
            ctx.shadowBlur = shadowBlur;
            ctx.fillStyle = snakeColor;

            for (let i = snake.length - 1; i >= 0; i--) {
                const s = snake[i];
                const size = gridSize - 5;
                const px = s.x * gridSize + (gridSize - size) / 2;
                const py = s.y * gridSize + (gridSize - size) / 2;

                const alpha = 0.35 + (i === 0 ? 0.65 : Math.max(0, 1 - i * 0.07));
                ctx.fillStyle = snakeColor.replace("60%", `${60 + i * 1}%`).replace("hsl", `hsla`).replace(")", `,${alpha})`);
                ctx.beginPath();
                ctx.roundRect(px, py, size, size, borderRadius);
                ctx.fill();
            }

            const head = snake[0];
            const hx = head.x * gridSize + gridSize / 2;
            const hy = head.y * gridSize + gridSize / 2;
            ctx.shadowBlur = 0;

            const second = snake[1] || head;
            const dx = head.x - second.x;
            const dy = head.y - second.y;
            const offsetX = (dx * 4);
            const offsetY = (dy * 4);

            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(hx - 3 + offsetX, hy - 3 + offsetY, 3, 0, Math.PI * 2);
            ctx.arc(hx + 3 + offsetX, hy - 3 + offsetY, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = eyePupilColor;
            ctx.beginPath();
            ctx.arc(hx - 3 + offsetX, hy - 3 + offsetY, 1.4, 0, Math.PI * 2);
            ctx.arc(hx + 3 + offsetX, hy - 3 + offsetY, 1.4, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawFood() {
            const cx = food.x * gridSize + gridSize / 2;
            const cy = food.y * gridSize + gridSize / 2;

            // Tema bazlƒ± renkler
            let foodColor, glowColor, highlightColor, stemColor, leafColor;
            
            if (currentTheme === "retro") {
                foodColor = "#e94560";
                glowColor = "rgba(233,69,96,0.6)";
                highlightColor = "rgba(255,255,255,0.9)";
                stemColor = "#ffc107";
                leafColor = "#ffc107";
            } else if (currentTheme === "minimal") {
                foodColor = "#ef4444";
                glowColor = "rgba(239,68,68,0.2)";
                highlightColor = "rgba(254,242,242,0.9)";
                stemColor = "#10b981";
                leafColor = "#10b981";
            } else {
                // Neon (varsayƒ±lan)
                foodColor = "#f97373";
                glowColor = "rgba(248,113,113,0.9)";
                highlightColor = "rgba(254,242,242,0.9)";
                stemColor = "#16a34a";
                leafColor = "#22c55e";
            }

            // Glow efekti (sadece neon ve retro temalarda)
            if (currentTheme !== "minimal") {
                const gradient = ctx.createRadialGradient(cx, cy, 2, cx, cy, gridSize / 1.3);
                gradient.addColorStop(0, glowColor);
                gradient.addColorStop(1, glowColor.replace("0.9", "0").replace("0.6", "0"));
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(cx, cy, gridSize / 1.3, 0, Math.PI * 2);
                ctx.fill();
            }

            // Ana yem
            ctx.fillStyle = foodColor;
            ctx.beginPath();
            ctx.arc(cx, cy, gridSize / 2.3, 0, Math.PI * 2);
            ctx.fill();

            // Highlight
            ctx.fillStyle = highlightColor;
            ctx.beginPath();
            ctx.arc(cx - 4, cy - 4, 3, 0, Math.PI * 2);
            ctx.fill();

            // Sap
            ctx.strokeStyle = stemColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy - gridSize / 2.3);
            ctx.lineTo(cx + 3, cy - gridSize / 1.8);
            ctx.stroke();

            // Yaprak
            ctx.fillStyle = leafColor;
            ctx.beginPath();
            ctx.ellipse(cx + 5, cy - gridSize / 2.2, 4, 6, -0.4, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawTemporaryLife(tempLife) {
            const fx = tempLife.position.x * gridSize + gridSize / 2;
            const fy = tempLife.position.y * gridSize + gridSize / 2;
            const currentTime = performance.now();
            const elapsed = currentTime - tempLife.spawnTime;
            const remainingTime = tempLifeDuration - elapsed;
            
            // Kalan s√ºreye g√∂re yanƒ±p s√∂nme efekti
            const blinkSpeed = 200; // milisaniye
            const blinkCycle = elapsed % (blinkSpeed * 2);
            let alpha = 255;
            if (blinkCycle < blinkSpeed) {
                alpha = 255;
            } else {
                alpha = Math.floor(255 * (1 - (blinkCycle - blinkSpeed) / blinkSpeed));
            }
            if (remainingTime < 1000) { // Son saniye daha hƒ±zlƒ± yanƒ±p s√∂ns√ºn
                const fastBlink = remainingTime % 300;
                alpha = Math.floor(255 * (fastBlink / 300));
            }
            
            // Kalp √ßizimi (parlayan)
            const heartColor = `rgba(255, 100, 100, ${alpha / 255})`;
            const glowColor = `rgba(255, 200, 200, ${alpha / 255 * 0.5})`;
            const size = gridSize / 2;
            
            // Parlama efekti
            ctx.fillStyle = glowColor;
            ctx.beginPath();
            ctx.arc(fx, fy, size + 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Ana kalp
            ctx.fillStyle = heartColor;
            ctx.beginPath();
            ctx.arc(fx, fy, size, 0, Math.PI * 2);
            ctx.fill();
            
            // ƒ∞√ß parlaklƒ±k
            ctx.fillStyle = `rgba(255, 200, 200, ${alpha / 255 * 0.7})`;
            ctx.beginPath();
            ctx.arc(fx - 2, fy - 2, size / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function applyShake() {
            if (shakeTime > 0) {
                const dx = (Math.random() - 0.5) * shakeStrength;
                const dy = (Math.random() - 0.5) * shakeStrength;
                ctx.save();
                ctx.translate(dx, dy);
                shakeTime--;
                return true;
            }
            return false;
        }

        function restoreAfterShake(didShake) {
            if (didShake) {
                ctx.restore();
            }
        }

        function draw() {
            // Snake ve food tanƒ±mlƒ± deƒüilse √ßizme
            if (!snake || !food) {
                drawBoard();
                return;
            }
            
            const didShake = applyShake();
            drawBoard();
            drawFood();
            // S√ºreli can √∂ƒüelerini √ßiz
            for (const tempLife of temporaryLifeItems) {
                drawTemporaryLife(tempLife);
            }
            drawSnake();
            updateParticles();
            drawParticles();

            // √áarpƒ±≈üma geri sayƒ±mƒ± g√∂ster
            if (collisionPause) {
                const remainingMs = Math.max(0, collisionResumeTime - performance.now());
                const remainingSec = Math.max(1, Math.ceil(remainingMs / 1000));
                ctx.fillStyle = "rgba(15,23,42,0.85)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "rgba(255, 200, 200, 0.9)";
                ctx.font = "bold 60px Arial";
                ctx.textAlign = "center";
                ctx.fillText(String(remainingSec), canvas.width / 2, canvas.height / 2);
            }

            if (paused && !gameOver) {
                ctx.fillStyle = "rgba(15,23,42,0.75)";
                ctx.fillRect(0, canvas.height / 2 - 32, canvas.width, 64);
                ctx.fillStyle = "#e5e7eb";
                ctx.font = "20px Arial";
                ctx.textAlign = "center";
                ctx.fillText("Duraklatƒ±ldƒ± (P ile devam et)", canvas.width / 2, canvas.height / 2 + 6);
            }

            restoreAfterShake(didShake);
        }

        function tick() {
            if (paused || gameOver || !snake || !food) {
                draw();
                return;
            }

            // √áarpƒ±≈üma bekleme s√ºresini kontrol et
            if (collisionPause) {
                if (performance.now() >= collisionResumeTime) {
                    collisionPause = false;
                    collisionGraceActive = true;
                    collisionGraceSteps = snake.length;
                } else {
                    draw();
                    return;
                }
            }

            // Grace period kontrol√º
            if (collisionGraceActive && collisionGraceSteps > 0) {
                collisionGraceSteps--;
                if (collisionGraceSteps === 0) {
                    collisionGraceActive = false;
                }
            }

            // S√ºreli can √∂ƒüelerini kontrol et ve kaldƒ±r
            const currentTime = performance.now();
            temporaryLifeItems = temporaryLifeItems.filter(tl => 
                currentTime - tl.spawnTime < tempLifeDuration
            );

            // S√ºreli can √∂ƒüesi olu≈üturma (ekranda g√∂r√ºn√ºr)
            if (!collisionPause && temporaryLifeItems.length === 0) {
                if (currentTime - tempLifeSpawnTimer >= tempLifeSpawnInterval) {
                    // Yeni s√ºreli can √∂ƒüesi ekle
                    let tempLife = {
                        position: randomFood(),
                        spawnTime: currentTime
                    };
                    // Yƒ±lan, yem veya engel ile √ßakƒ±≈ümasƒ±n
                    while (
                        (tempLife.position.x === snake[0].x && tempLife.position.y === snake[0].y) ||
                        (tempLife.position.x === food.x && tempLife.position.y === food.y) ||
                        snake.some(s => s.x === tempLife.position.x && s.y === tempLife.position.y) ||
                        (obstacles && obstacles.some(obs => obs.x === tempLife.position.x && obs.y === tempLife.position.y))
                    ) {
                        tempLife.position = randomFood();
                    }
                    temporaryLifeItems.push(tempLife);
                    tempLifeSpawnTimer = currentTime;
                }
            }

            let head = {
                x: snake[0].x + vx,
                y: snake[0].y + vy
            };

            // Duvara √ßarpma kontrol√º
            if (
                head.x < 0 || head.x >= tileCount ||
                head.y < 0 || head.y >= tileCount
            ) {
                // Duvarlƒ± modda duvardan √ßarpƒ±nca can sistemi devreye girer
                if (gameMode === "duvarlƒ±") {
                    return handleCollision();
                }
                // Klasik, hƒ±zlƒ± ve random modda duvardan ge√ßer (wrap around)
                if (head.x < 0) head.x = tileCount - 1;
                if (head.x >= tileCount) head.x = 0;
                if (head.y < 0) head.y = tileCount - 1;
                if (head.y >= tileCount) head.y = 0;
            }
            
            // Random harita modunda engellere √ßarpma kontrol√º
            if (gameMode === "random" && obstacles.length > 0) {
                for (const obstacle of obstacles) {
                    if (head.x === obstacle.x && head.y === obstacle.y) {
                        return handleCollision();
                    }
                }
            }

            // Kendi v√ºcuduna √ßarpma kontrol√º (grace period varsa ignore_self)
            if (!collisionGraceActive || collisionGraceSteps === 0) {
                for (let i = 0; i < snake.length; i++) {
                    if (snake[i].x === head.x && snake[i].y === head.y) {
                        return handleCollision();
                    }
                }
            }

            // √ñnceki v√ºcudu kaydet (yeniden doƒüma i√ßin)
            previousSnakeBody = JSON.parse(JSON.stringify(snake));

            snake.unshift(head);

            // S√ºreli can √∂ƒüesi toplama kontrol√º
            const headPos = {x: head.x, y: head.y};
            for (let i = temporaryLifeItems.length - 1; i >= 0; i--) {
                const tempLife = temporaryLifeItems[i];
                if (tempLife.position.x === headPos.x && tempLife.position.y === headPos.y) {
                    // S√ºreli can toplandƒ± - maksimum 3 can kontrol√º
                    const totalLives = lives + activeTemporaryLives.length;
                    if (totalLives < 3) {
                        activeTemporaryLives.push(1);
                        temporaryLifeItems.splice(i, 1);
                        updateLivesDisplay();
                    } else {
                        // Maksimum can sayƒ±sƒ±na ula≈üƒ±ldƒ±, s√ºreli can √∂ƒüesini kaldƒ±r
                        temporaryLifeItems.splice(i, 1);
                    }
                }
            }

            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreSpan.textContent = score;
                const centerX = head.x * gridSize + gridSize / 2;
                const centerY = head.y * gridSize + gridSize / 2;
                spawnParticles(centerX, centerY, "rgb(248,113,113)");
                
                // Elma yeme sesi
                playSound("eat");

                // Yeni yem olu≈ütur (engellerle √ßakƒ±≈ümamasƒ± i√ßin randomFood zaten kontrol ediyor)
                food = randomFood();
                // Yem engelle √ßakƒ±≈üƒ±yorsa tekrar olu≈ütur
                let attempts = 0;
                while (
                    obstacles.some(obs => obs.x === food.x && obs.y === food.y) &&
                    attempts < 50
                ) {
                    food = randomFood();
                    attempts++;
                }

                const newLevel = 1 + Math.floor(score / 5);
                if (newLevel !== level) {
                    level = newLevel;
                    levelSpan.textContent = level;
                    // Level-up sesi
                    playSound("level");
                }

                // Her 10 puan kazanƒ±nca can kazan
                if (score > 0 && score % 10 === 0 && score !== lastScoreForLife) {
                    const totalLives = lives + activeTemporaryLives.length;
                    if (totalLives < 3) { // Maksimum 3 can (toplam)
                        lives++;
                        updateLivesDisplay();
                    }
                    lastScoreForLife = score;
                }

                restartLoop();
            } else {
                snake.pop();
            }

            draw();
        }

        function handleCollision() {
            let lifeConsumed = false;
            
            if (activeTemporaryLives.length > 0) {
                activeTemporaryLives.pop();
                lifeConsumed = true;
            } else if (lives > 0) {
                lives--;
                lifeConsumed = true;
            } else {
                // Can yok, oyun bitti
                return endGame();
            }

            if (lifeConsumed) {
                // √áarpma sesi
                playSound("hit");
                
                // Yƒ±lanƒ± √∂nceki haline geri al
                if (previousSnakeBody) {
                    snake = JSON.parse(JSON.stringify(previousSnakeBody));
                }
                // Y√∂n√º tersine √ßevir
                vx = -vx;
                vy = -vy;
                // √áarpƒ±≈üma bekleme s√ºresi ba≈ülat
                collisionPause = true;
                collisionGraceActive = false;
                collisionGraceSteps = snake.length;
                collisionResumeTime = performance.now() + 2000; // 2 saniye
                updateLivesDisplay();
            }
        }

        async function endGame() {
            gameOver = true;
            shakeTime = 24;
            shakeStrength = 8;
            
            // Oyun biti≈ü sesi
            playSound("hit");

            if (score > highScore) {
                highScore = score;
                localStorage.setItem("snakeHighScoreV3", String(highScore));
                highSpan.textContent = highScore;
                if (highLabel) {
                    highLabel.textContent = "En Y√ºksek (local)";
                }
            }
            
            // Oyun bittiƒüinde veritabanƒ±ndan g√ºncel en y√ºksek skoru √ßek
            await loadHighestScore();
            
            // Oyun bittiƒüinde veritabanƒ±ndan g√ºncel en y√ºksek skoru √ßek
            await loadHighestScore();

            // Otomatik kaydet (misafir deƒüilse ve kullanƒ±cƒ± adƒ± varsa)
            if (!guestMode && currentUsername && score > 0) {
                const result = await saveScoreToServer(currentUsername, score);
                if (result && result.ok) {
                    // Skor kaydedildi, leaderboard'u g√ºncelle
                    loadTopScores();
                }
            }

            showOverlay();
        }

        function showOverlay() {
            overlayScore.textContent = `Skorun: ${score}`;
            const highText = dbHighScore > 0 && dbHighScore >= highScore 
                ? `En y√ºksek: ${dbHighScore}` 
                : `Local en y√ºksek: ${highScore}`;
            overlayHigh.textContent = highText;
            overlay.style.display = "flex";
            
            const nameRow = document.getElementById("name-row");
            
            // Misafir modunda veya kullanƒ±cƒ± adƒ± yoksa kaydet butonunu g√∂ster
            if (guestMode || !currentUsername) {
                nameRow.style.display = "flex";
                nameInput.value = "";
                nameInput.disabled = false;
                nameInput.focus();
                btnSave.style.display = "inline-block";
                saveStatus.textContent = "";
                if (!guestMode && !currentUsername) {
                    saveStatus.textContent = "Skorunuzu kaydetmek i√ßin isminizi girin";
                    saveStatus.style.color = "var(--text-muted)";
                }
            } else {
                // Giri≈ü yapƒ±lmƒ±≈ü kullanƒ±cƒ± i√ßin otomatik kaydedildi
                nameRow.style.display = "none";
                saveStatus.textContent = "Skorunuz otomatik olarak kaydedildi! ‚úÖ";
                saveStatus.style.color = "#4ade80";
            }
        }

        function hideOverlay() {
            overlay.style.display = "none";
        }

        // ---- API ƒ∞≈ûLEMLERƒ∞ ----

        async function saveScoreToServer(username, score) {
            try {
                const res = await fetch("/api/score/submit/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username, score }),
                });

                if (!res.ok) {
                    return { ok: false };
                }
                const data = await res.json();
                return data;
            } catch (err) {
                console.error(err);
                return { ok: false };
            }
        }

        async function loadTopScores() {
            try {
                const res = await fetch("/api/score/top/?limit=10");
                if (!res.ok) throw new Error("http");
                const data = await res.json();
                const list = data.results || [];

                lbBody.innerHTML = "";
                if (!list.length) {
                    lbEmpty.style.display = "block";
                    return;
                }
                lbEmpty.style.display = "none";

                list.forEach((item, index) => {
                    const tr = document.createElement("tr");

                    const tdRank = document.createElement("td");
                    tdRank.className = "rank-badge rank-" + (index + 1);
                    tdRank.textContent = index + 1;

                    const tdName = document.createElement("td");
                    tdName.className = "lb-name";
                    tdName.textContent = item.username;

                    const tdScore = document.createElement("td");
                    tdScore.className = "lb-score";
                    tdScore.textContent = item.score;

                    tr.appendChild(tdRank);
                    tr.appendChild(tdName);
                    tr.appendChild(tdScore);
                    lbBody.appendChild(tr);
                });
            } catch (err) {
                console.error("Leaderboard y√ºklenemedi", err);
                lbEmpty.style.display = "block";
                lbEmpty.textContent = "Skorlar y√ºklenirken hata olu≈ütu.";
            }
        }

        btnSave.addEventListener("click", async () => {
            const username = nameInput.value.trim();
            if (!username) {
                saveStatus.style.color = "#f97373";
                saveStatus.textContent = "√ñnce adƒ±nƒ± yaz.";
                return;
            }
            btnSave.disabled = true;
            saveStatus.style.color = "#a5b4fc";
            saveStatus.textContent = "Kaydediliyor...";

            const result = await saveScoreToServer(username, score);

            if (result && result.ok) {
                saveStatus.style.color = "#4ade80";
                saveStatus.textContent = "Skor kaydedildi! üôå";
                loadTopScores();
            } else {
                saveStatus.style.color = "#f97373";
                saveStatus.textContent = "Kaydedilemedi, sonra tekrar dene.";
                btnSave.disabled = false;
            }
        });

        nameInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                btnSave.click();
            }
        });

        // ---- Kontroller ----
        function handleMovement(key) {
            if (controlScheme === "wasd") {
                if ((key === "w" || key === "W") && vy !== 1) {
                    vx = 0; vy = -1;
                } else if ((key === "s" || key === "S") && vy !== -1) {
                    vx = 0; vy = 1;
                } else if ((key === "a" || key === "A") && vx !== 1) {
                    vx = -1; vy = 0;
                } else if ((key === "d" || key === "D") && vx !== -1) {
                    vx = 1; vy = 0;
                }
            } else {
                // Y√∂n tu≈ülarƒ± (varsayƒ±lan)
                if (key === "ArrowUp" && vy !== 1) {
                    vx = 0; vy = -1;
                } else if (key === "ArrowDown" && vy !== -1) {
                    vx = 0; vy = 1;
                } else if (key === "ArrowLeft" && vx !== 1) {
                    vx = -1; vy = 0;
                } else if (key === "ArrowRight" && vx !== -1) {
                    vx = 1; vy = 0;
                }
            }
        }

        function handleDirection(direction) {
            // direction: "up", "down", "left", "right"
            if (direction === "up" && vy !== 1) {
                vx = 0; vy = -1;
            } else if (direction === "down" && vy !== -1) {
                vx = 0; vy = 1;
            } else if (direction === "left" && vx !== 1) {
                vx = -1; vy = 0;
            } else if (direction === "right" && vx !== -1) {
                vx = 1; vy = 0;
            }
        }

        document.addEventListener("keydown", (e) => {
            // Ayarlar ekranƒ±ndayken kontrolleri devre dƒ±≈üƒ± bƒ±rak
            if (currentScreen === "settings") {
                return;
            }

            // Hareket kontrolleri
            handleMovement(e.key);

            // Diƒüer kontroller
            if (e.key.toLowerCase() === "r") {
                resetGame();
            } else if (e.key.toLowerCase() === "p") {
                if (gameOver) return;
                paused = !paused;
            }
        });

        // ========== MOBƒ∞L KONTROLLER (Swipe/Kaydƒ±rma) ==========
        // Swipe (kaydƒ±rma) kontrolleri - Sadece parmakla kaydƒ±rarak oynama
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const minSwipeDistance = 20; // Minimum kaydƒ±rma mesafesi (daha hassas)

        const gameLayout = document.getElementById("game-layout");
        
        // T√ºm oyun ekranƒ±na swipe ekle (sadece canvas deƒüil)
        if (gameLayout) {
            gameLayout.addEventListener("touchstart", (e) => {
                if (currentScreen !== "game" || gameOver || paused) return;
                // Overlay veya butonlara tƒ±klanƒ±yorsa swipe yapma
                if (e.target.closest("#overlay") || e.target.closest("button") || e.target.closest("input")) {
                    return;
                }
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
            }, { passive: true });

            gameLayout.addEventListener("touchend", (e) => {
                if (currentScreen !== "game" || gameOver || paused) return;
                // Overlay veya butonlara tƒ±klanƒ±yorsa swipe yapma
                if (e.target.closest("#overlay") || e.target.closest("button") || e.target.closest("input")) {
                    return;
                }
                const touch = e.changedTouches[0];
                touchEndX = touch.clientX;
                touchEndY = touch.clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);

                // Yeterince kaydƒ±rma yapƒ±ldƒ± mƒ±?
                if (absDeltaX < minSwipeDistance && absDeltaY < minSwipeDistance) {
                    return; // √áok k√º√ß√ºk hareket, yok say
                }

                // Hangi y√∂ne kaydƒ±rƒ±ldƒ±?
                if (absDeltaX > absDeltaY) {
                    // Yatay kaydƒ±rma
                    if (deltaX > 0) {
                        handleDirection("right");
                    } else {
                        handleDirection("left");
                    }
                } else {
                    // Dikey kaydƒ±rma
                    if (deltaY > 0) {
                        handleDirection("down");
                    } else {
                        handleDirection("up");
                    }
                }
            }, { passive: true });
        }


        btnRestart.addEventListener("click", () => {
            resetGame();
        });

        const btnMenu = document.getElementById("btn-menu");
        if (btnMenu) {
            btnMenu.addEventListener("click", () => {
                if (guestMode) {
                    guestMode = false;
                    currentUsername = "";
                    showScreen("login");
                } else {
                    showScreen("menu");
                }
                gameOver = false;
                hideOverlay();
            });
        }

        // Oyun sadece game ekranƒ±ndayken √ßalƒ±≈üsƒ±n
        let lastTickTime = 0;
        function gameLoop(currentTime) {
            if (currentScreen === "game") {
                draw();
                
                if (!gameOver && !paused && snake && food) {
                    const interval = getIntervalByScore(score || 0);
                    if (lastTickTime === 0 || currentTime - lastTickTime >= interval) {
                        tick();
                        lastTickTime = currentTime;
                    }
                }
            }
            requestAnimationFrame(gameLoop);
        }

        // ƒ∞lk ba≈ülatma
        draw();
        loadTopScores();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
